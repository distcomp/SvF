name: Build and publish SvF image to GHCR

on:
  push:
    branches:
      - master
      - docker
      - 'release/**'

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/svf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Clone external repositories
        run: |
          git clone https://github.com/distcomp/pyomo-everest.git
          git clone https://gitlab.com/everest/python-api.git pyomo-everest/python-api

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tags
        id: meta
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          SHORT_SHA="$(git rev-parse --short HEAD)"

          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "pinned_tag=cached-${BRANCH}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        run: |
          BRANCH="${{ steps.meta.outputs.branch }}"
          PINNED="${{ steps.meta.outputs.pinned_tag }}"
          SHORT_SHA="${{ steps.meta.outputs.short_sha }}"

          GIT_TAG="$(git describe --tags --exact-match 2>/dev/null || echo '')"

          docker buildx build \
            --push \
            --file docker/Dockerfile \
            --tag "${IMAGE_NAME}:${BRANCH}" \
            --tag "${IMAGE_NAME}:${PINNED}" \
            --build-arg GIT_COMMIT="${GITHUB_SHA}" \
            --build-arg GIT_BRANCH="${BRANCH}" \
            --build-arg GIT_TAG="${GIT_TAG}" \
            --build-arg DOCKER_IMAGE="${IMAGE_NAME}" \
            --build-arg DOCKER_TAG="${BRANCH}" \
            .

